# Migration `20200613124503-prisma-refactor`

This migration has been generated by elliotsoomro at 6/13/2020, 12:45:03 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
DROP INDEX "public"."FieldData.fieldName"

ALTER TABLE "public"."Card" DROP CONSTRAINT IF EXiSTS "Card_deckId_fkey",
DROP CONSTRAINT IF EXiSTS "Card_typeId_fkey",
DROP COLUMN "deckId",
DROP COLUMN "typeId";

ALTER TABLE "public"."Note" ADD COLUMN "deckId" text  NOT NULL ;

ALTER TABLE "public"."NoteType" ADD COLUMN "userId" text  NOT NULL ;

ALTER TABLE "public"."User" ALTER COLUMN "role" SET DEFAULT E'USER';

CREATE UNIQUE INDEX "FieldData.fieldName_noteId" ON "public"."FieldData"("fieldName","noteId")

ALTER TABLE "public"."Note" ADD FOREIGN KEY ("deckId")REFERENCES "public"."Deck"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."NoteType" ADD FOREIGN KEY ("userId")REFERENCES "public"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200519191152-initial-migration..20200613124503-prisma-refactor
--- datamodel.dml
+++ datamodel.dml
@@ -2,9 +2,9 @@
 // learn more about it in the docs: https://pris.ly/d/prisma-schema
 datasource db {
   provider = "postgresql"
-  url = "***"
+  url      = env("DATABASE_URL")
 }
 generator client {
   provider = "prisma-client-js"
@@ -15,24 +15,27 @@
   ADMIN
 }
 model User {
-  id        String    @id @default(cuid())
-  username  String    @unique
-  email     String    @unique
+  id        String      @id @default(cuid())
+  username  String      @unique
+  email     String      @unique
   password  String
-  role      Role      @default(USER)
+  role      Role        @default(USER)
   decks     Deck[]
-  createdAt DateTime  @default(now())
-  updatedAt DateTime  @updatedAt()
+  noteTypes NoteType[]
+  createdAt DateTime    @default(now())
+  updatedAt DateTime    @updatedAt()
 }
 model NoteType {
   id          String      @id @default(cuid()) 
   name        String
   fields      String[]
   cardTypes   CardType[]
   notes       Note[]
+  user        User        @relation(fields: [userId], references: [id])
+  userId      String
   createdAt   DateTime    @default(now())
   updatedAt   DateTime    @updatedAt()
 }
@@ -42,49 +45,48 @@
   front       String
   back        String
   noteType    NoteType @relation(fields: [noteTypeId], references: [id])
   noteTypeId  String
-  cards       Card[]
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt()
 }
 model Note {
   id          String      @id @default(cuid())
-  fields      FieldData[]
+  fieldData   FieldData[]
   cards       Card[]
   type        NoteType    @relation(fields: [typeId], references: [id])
   typeId      String
+  deck        Deck        @relation(fields: [deckId], references: [id])
+  deckId      String
   createdAt   DateTime    @default(now())
   updatedAt   DateTime    @updatedAt()
 }
 model FieldData {
   id        String    @id @default(cuid())
-  fieldName String    @unique
+  fieldName String    
   value     String
   note      Note      @relation(fields: [noteId], references: [id])
   noteId    String
   createdAt DateTime  @default(now())
   updatedAt DateTime  @updatedAt()
+
+  @@unique([fieldName, noteId])
 }
 model Card {
   id        String    @id @default(cuid())
   due       DateTime  @default(now())
-  deck      Deck      @relation(fields: [deckId], references: [id])
-  deckId    String
   note      Note      @relation(fields: [noteId], references: [id])
   noteId    String
-  type      CardType  @relation(fields: [typeId], references: [id])
-  typeId    String
   createdAt DateTime  @default(now())
   updatedAt DateTime  @updatedAt()
 }
 model Deck {
   id        String  @id @default(cuid())
   name      String
-  cards     Card[]
+  notes     Note[]
   user      User    @relation(fields: [userId], references: [id])
   userId    String
 }
```


